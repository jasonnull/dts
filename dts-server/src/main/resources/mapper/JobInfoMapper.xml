<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.jasonnull.dts.server.dao.JobInfoDao">

    <sql id="Base_Column_List">
        t.job_id,
        t.job_group,
        t.job_cron,
        t.job_desc,
        t.add_time,
        t.update_time,
        t.author,
        t.alarm_email,
        t.executor_route_strategy,
        t.executor_handler,
        t.executor_param,
        t.executor_block_strategy,
        t.executor_fail_strategy,
        t.executor_timeout,
        t.glue_type,
        t.glue_source,
        t.glue_remark,
        t.glue_updatetime,
        t.child_jobid
    </sql>

    <select id="pageList" parameterType="java.util.HashMap" resultType="JobInfo">
        SELECT
        <include refid="Base_Column_List"/>
        FROM XXL_JOB_QRTZ_TRIGGER_INFO AS t
        <trim prefix="WHERE" prefixOverrides="AND | OR">
            <if test="jobGroup gt 0">
                AND t.job_group = #{jobGroup}
            </if>
            <if test="jobDesc != null and jobDesc != ''">
                AND t.job_desc like CONCAT(CONCAT('%', #{jobDesc}), '%')
            </if>
            <if test="executorHandler != null and executorHandler != ''">
                AND t.executor_handler like CONCAT(CONCAT('%', #{executorHandler}), '%')
            </if>
        </trim>
        ORDER BY job_id DESC
        LIMIT #{offset}, #{pagesize}
    </select>

    <select id="pageListCount" parameterType="java.util.HashMap" resultType="int">
        SELECT count(1)
        FROM XXL_JOB_QRTZ_TRIGGER_INFO AS t
        <trim prefix="WHERE" prefixOverrides="AND | OR">
            <if test="jobGroup gt 0">
                AND t.job_group = #{jobGroup}
            </if>
            <if test="jobDesc != null and jobDesc != ''">
                AND t.job_desc like CONCAT(CONCAT('%', #{jobDesc}), '%')
            </if>
            <if test="executorHandler != null and executorHandler != ''">
                AND t.executor_handler like CONCAT(CONCAT('%', #{executorHandler}), '%')
            </if>
        </trim>
    </select>

    <insert id="save" parameterType="io.github.jasonnull.dts.server.model.JobInfo" useGeneratedKeys="true"
            keyProperty="jobId">
        INSERT INTO XXL_JOB_QRTZ_TRIGGER_INFO (
        job_group,
        job_cron,
        job_desc,
        add_time,
        update_time,
        author,
        alarm_email,
        executor_route_strategy,
        executor_handler,
        executor_param,
        executor_block_strategy,
        executor_fail_strategy,
        executor_timeout,
        glue_type,
        glue_source,
        glue_remark,
        glue_updatetime,
        child_jobid
        ) VALUES (
        #{jobGroup},
        #{jobCron},
        #{jobDesc},
        NOW(),
        NOW(),
        #{author},
        #{alarmEmail},
        #{executorRouteStrategy},
        #{executorHandler},
        #{executorParam},
        #{executorBlockStrategy},
        #{executorFailStrategy},
        #{executorTimeout},
        #{glueType},
        #{glueSource},
        #{glueRemark},
        NOW(),
        #{childJobId}
        );
        <!--<selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="jobGroup">
            SELECT LAST_INSERT_ID()
            /*SELECT @@IDENTITY AS jobGroup*/
        </selectKey>-->
    </insert>

    <select id="loadById" parameterType="java.util.HashMap" resultType="JobInfo">
        SELECT
        <include refid="Base_Column_List"/>
        FROM XXL_JOB_QRTZ_TRIGGER_INFO AS t
        WHERE t.job_id = #{jobId}
    </select>

    <update id="update" parameterType="io.github.jasonnull.dts.server.model.JobInfo">
        UPDATE XXL_JOB_QRTZ_TRIGGER_INFO
        SET
            job_cron = #{jobCron},
            job_desc = #{jobDesc},
            update_time = NOW(),
            author = #{author},
            alarm_email = #{alarmEmail},
            executor_route_strategy = #{executorRouteStrategy},
            executor_handler = #{executorHandler},
            executor_param = #{executorParam},
            executor_block_strategy = #{executorBlockStrategy},
            executor_fail_strategy = #{executorFailStrategy},
            executor_timeout = ${executorTimeout},
            glue_type = #{glueType},
            glue_source = #{glueSource},
            glue_remark = #{glueRemark},
            glue_updatetime = #{glueUpdatetime},
            child_jobid = #{childJobId}
        WHERE job_id = #{jobId}
    </update>

    <delete id="delete" parameterType="java.util.HashMap">
        DELETE
        FROM XXL_JOB_QRTZ_TRIGGER_INFO
        WHERE job_id = #{jobId}
    </delete>

    <select id="getJobsByGroup" parameterType="java.util.HashMap" resultType="JobInfo">
        SELECT
        <include refid="Base_Column_List"/>
        FROM XXL_JOB_QRTZ_TRIGGER_INFO AS t
        WHERE t.job_group = #{jobGroup}
    </select>

    <select id="findAllCount" resultType="int">
        SELECT count(1)
        FROM XXL_JOB_QRTZ_TRIGGER_INFO
    </select>

</mapper>